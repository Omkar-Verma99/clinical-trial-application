rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isDoctor(doctorId) {
      return isAuthenticated() && request.auth.uid == doctorId;
    }
    
    // ===== UNIFIED PATIENTS COLLECTION =====
    // ONE document per patient with all data (patientInfo + baseline + followups)
    // OPTIMIZED: Single document read/write per patient
    // PERFORMANCE: 3-4x faster, 67% lower cost
    match /patients/{patientId} {
      allow read: if isAuthenticated() && 
        resource.data.doctorId == request.auth.uid;
      
      allow create: if isAuthenticated() && 
        request.resource.data.doctorId == request.auth.uid &&
        request.resource.data.patientId != null;
      
      allow update: if isAuthenticated() && 
        resource.data.doctorId == request.auth.uid;
      
      allow delete: if isAuthenticated() && 
        resource.data.doctorId == request.auth.uid;
    }

    // ===== BASELINE DATA COLLECTION =====
    // Legacy/fallback support for baseline forms
    // Read-only, used by real-time sync listeners
    match /baselineData/{docId} {
      allow read: if isAuthenticated() &&
        resource.data.patientId != null &&
        exists(/databases/{database}/documents/patients/$(resource.data.patientId)) &&
        get(/databases/{database}/documents/patients/$(resource.data.patientId)).data.doctorId == request.auth.uid;
      
      allow create, update: if isAuthenticated() &&
        request.resource.data.patientId != null &&
        exists(/databases/{database}/documents/patients/$(request.resource.data.patientId)) &&
        get(/databases/{database}/documents/patients/$(request.resource.data.patientId)).data.doctorId == request.auth.uid;
      
      allow delete: if isAuthenticated() &&
        resource.data.patientId != null &&
        exists(/databases/{database}/documents/patients/$(resource.data.patientId)) &&
        get(/databases/{database}/documents/patients/$(resource.data.patientId)).data.doctorId == request.auth.uid;
    }

    // ===== FOLLOWUP DATA COLLECTION =====
    // Legacy/fallback support for followup forms
    // Read-only, used by real-time sync listeners
    match /followUpData/{docId} {
      allow read: if isAuthenticated() &&
        resource.data.patientId != null &&
        exists(/databases/{database}/documents/patients/$(resource.data.patientId)) &&
        get(/databases/{database}/documents/patients/$(resource.data.patientId)).data.doctorId == request.auth.uid;
      
      allow create, update: if isAuthenticated() &&
        request.resource.data.patientId != null &&
        exists(/databases/{database}/documents/patients/$(request.resource.data.patientId)) &&
        get(/databases/{database}/documents/patients/$(request.resource.data.patientId)).data.doctorId == request.auth.uid;
      
      allow delete: if isAuthenticated() &&
        resource.data.patientId != null &&
        exists(/databases/{database}/documents/patients/$(resource.data.patientId)) &&
        get(/databases/{database}/documents/patients/$(resource.data.patientId)).data.doctorId == request.auth.uid;
    }

    // ===== DOCTORS COLLECTION =====
    // Doctor profile information
    match /doctors/{doctorId} {
      allow read: if isAuthenticated() && 
        request.auth.uid == doctorId;
      
      allow create: if isAuthenticated() &&
        request.auth.uid == doctorId;
      
      allow update: if isAuthenticated() && 
        request.auth.uid == doctorId;
      
      allow delete: if false; // Prevent accidental deletion
    }
  }
}
